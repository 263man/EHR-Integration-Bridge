name: Deploy to Oracle VM (EHR Integration Bridge)

on:
  push:
    branches:
      - "main"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      - name: üîê Write private key to file (preserve newlines)
        run: |
          echo "[$(date -u)] Writing private key..."
          echo "${{ secrets.VM_KEY }}" | tr -d '\r' > private_key.pem
          chmod 600 private_key.pem
          echo "Private key file written and permissions set."

      - name: üîç Verify SSH connectivity
        run: |
          echo "[$(date -u)] Testing SSH connection to ${{ secrets.VM_HOST }}..."
          ssh -vvv -i private_key.pem \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} "echo '‚úÖ SSH connection OK' && hostname && whoami"

      - name: üöÄ Deploy over SSH with Docker Compose
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key_path: private_key.pem
          script_stop: true
          debug: true
          script: |
            set -euxo pipefail

            echo "=== [$(date -u)] START DEPLOYMENT ==="
            PROJECT_DIR="/home/${USER}/EHR-Integration-Bridge"
            COMPOSE_BIN="/usr/bin/docker-compose"

            echo "-> Checking environment..."
            whoami
            hostname
            uname -a
            which docker || echo "docker not found"
            which docker-compose || echo "docker-compose not found"
            $COMPOSE_BIN version || echo "compose version check failed"

            echo "-> Navigating to project directory..."
            cd "$PROJECT_DIR"
            pwd
            ls -la

            echo "-> Fetching latest changes..."
            git fetch origin main
            git reset --hard origin/main

            echo "-> Stopping existing containers..."
            sudo $COMPOSE_BIN down --remove-orphans || true

            echo "-> Building and starting containers..."
            sudo $COMPOSE_BIN up -d --build

            echo "-> Waiting for containers to stabilize..."
            sleep 10

            echo "-> Checking running containers..."
            sudo docker ps -a

            echo "-> Verifying backend health..."
            if curl -s --fail http://localhost:8080/swagger/v1/swagger.json -o /tmp/swagger.json; then
              echo "‚úÖ Backend Swagger reachable"
              stat -c '%s bytes' /tmp/swagger.json
            else
              echo "‚ùå Backend Swagger not reachable ‚Äî dumping recent logs"
              sudo $COMPOSE_BIN logs --tail=100 || true
              exit 3
            fi

            echo "=== [$(date -u)] DEPLOYMENT COMPLETE ==="
